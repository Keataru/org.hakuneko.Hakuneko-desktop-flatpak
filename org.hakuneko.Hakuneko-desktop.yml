---
app-id: org.hakuneko.Hakuneko-desktop
runtime: org.gnome.Platform/x86_64/3.28
sdk: org.gnome.Sdk/x86_64/3.28
base: org.electronjs.Electron2.BaseApp
base-version: stable

finish-args:
- "--share=ipc"
- "--share=network"
- "--socket=fallback-x11"
- "--socket=wayland"
- "--device=dri"
- "--filesystem=home"
- "--device=all"
- "--filesystem=xdg-run/dconf"
- "--filesystem=~/.config/dconf:ro"
- "--talk-name=ca.desrt.dconf"
- "--env=DCONF_USER_CONFIG_DIR=.config/dconf"


command: "/app/hakuneko-desktop/hakuneko"

modules:
- name: nodejs
  cleanup: 
  - "/include"
  - "/share"
  - "/app/lib/node_modules/npm/changelogs"
  - "/app/lib/node_modules/npm/doc"
  - "/app/lib/node_modules/npm/html"
  - "/app/lib/node_modules/npm/man"
  - "/app/lib/node_modules/npm/scripts"
  sources:
  - type: archive
    url: https://nodejs.org/dist/v8.11.1/node-v8.11.1.tar.xz
    sha256: 40a6eb51ea37fafcf0cfb58786b15b99152bec672cccf861c14d1cca0ad4758a

- name: hakuneko
  no-autogen: true
  buildsystem: simple
  build-options:
    build-args: 
    - "--share=network"
  build-commands:
  - npm install --prefix=./asar asar@0.14.3
  - ln -s /run/build/hakuneko/asar/node_modules/asar/bin/asar.js /app/bin/asar
  - install -Dm644 electron-v* electron/redist/electron-v2.0.7-linux-x64.zip
  - echo "; build \"\$1\" \"\$2\"" >> electron/build.sh
  - electron/build.sh linux-x64 linux-flatpak/usr/lib/hakuneko-desktop
  - rm /app/bin/asar
  - cp -R electron/build/linux-flatpak/usr/lib/hakuneko-desktop /app
  - install -Dm766 electron/res/logo_256_s.png /app/share/icons/hicolor/256x256/apps/org.hakuneko.Hakuneko-desktop.png
  
  sources:
  - type: archive
    path: hakuneko-0.4.0.tar.gz
    sha256: 544ac9f01999e5fa2f9bcaadfe357ef5322b2a7edf7b536223d96cad80153529
  - type: file
    url: https://github.com/electron/electron/releases/download/v2.0.7/electron-v2.0.7-linux-x64.zip
    sha256: 617f547285452940cf6be8af22075640989261f3f6fae8ab327426f0434b446c

- name: startup
  no-autogen: true
  buildsystem: simple
  build-commands:
  - install -Dm766 hakuneko-desktop.desktop /app/share/applications/org.hakuneko.Hakuneko-desktop.desktop

  sources:
  - type: file
    path: hakuneko-desktop.desktop
